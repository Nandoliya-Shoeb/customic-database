<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pen Pot Products | Customic Store</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-img { height: 220px; width: 100%; object-fit: contain; background: #fff; padding: 10px; border-bottom: 1px solid #eee; }
        .qty-box { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 10px 0; }
        .qty-box button { width: 35px; height: 35px; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .qty-box span { min-width: 30px; text-align: center; font-weight: bold; }
        .card { transition: transform 0.2s; border: none; border-radius: 12px; overflow: hidden; }
        .card:hover { transform: translateY(-5px); }
        .badge-discount { position: absolute; top: 10px; left: 10px; z-index: 5; }
    </style>
</head>
<body class="bg-light">

<div id="navbar"></div>

<div class="container mt-5 pt-4">
    <h2 class="text-center mb-4 fw-bold">üñäÔ∏è Pen Pot Collection</h2>
    
    <div class="row g-4" id="productsContainer">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Connecting to Database...</p>
        </div>
    </div>
</div>

<div id="footer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ================= CONFIG ================= */
const CATEGORY = "penpot"; // Admin panel se exact match kiya gaya hai
let products = [];

/* ============ LOAD FROM DATABASE ============== */
async function loadProducts() {
    try {
        const response = await fetch('/api/products');
        const allProducts = await response.json();
        
        // Filter by 'penpot'
        let filteredArr = allProducts.filter(p => p.category === CATEGORY);

        // Maintain quantity if already loaded
        let updated = filteredArr.map(p => {
            let existing = products.find(x => x.id === p.id);
            return { ...p, qty: existing ? existing.qty : 1 };
        });

        // Sirf tab update karein agar data change hua ho
        if (JSON.stringify(updated) !== JSON.stringify(products)) {
            products = updated;
            renderProducts();
        }
    } catch (err) {
        console.error("Database error:", err);
        document.getElementById("productsContainer").innerHTML = `<p class="text-center text-danger">Failed to load data.</p>`;
    }
}

/* ============ RENDER PRODUCTS ============== */
function renderProducts() {
    const container = document.getElementById("productsContainer");
    if (!container) return;
    container.innerHTML = "";

    if (products.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center text-muted py-5">
                <img src="https://cdn-icons-png.flaticon.com/512/5089/5089733.png" style="width:80px; opacity:0.5;">
                <h5 class="mt-3">No Pen Pots found in this category.</h5>
            </div>`;
        return;
    }

    products.forEach(p => {
        let col = document.createElement("div");
        col.className = "col-12 col-sm-6 col-md-4";
        col.innerHTML = `
            <div class="card h-100 shadow-sm">
                ${p.discount > 0 ? `<span class="badge bg-danger badge-discount">${p.discount}% OFF</span>` : ''}
                <img src="${p.image || 'https://via.placeholder.com/300'}" class="product-img">
                <div class="card-body text-center d-flex flex-column">
                    <h5 class="fw-bold mb-1">${p.name}</h5>
                    <div class="mb-2">
                        <span class="text-success fw-bold fs-5">‚Çπ${calculateTotal(p.price, p.discount, 1)}</span>
                        ${p.discount > 0 ? `<small class="text-muted text-decoration-line-through">‚Çπ${p.price}</small>` : ''}
                    </div>
                    <div class="qty-box">
                        <button class="btn btn-outline-secondary btn-sm rounded-circle" onclick="changeQty('${p.id}','minus')">‚àí</button>
                        <span id="qty${p.id}">${p.qty}</span>
                        <button class="btn btn-outline-secondary btn-sm rounded-circle" onclick="changeQty('${p.id}','plus')">+</button>
                    </div>
                    <p class="small text-muted mb-3">Total: <span class="fw-bold text-dark" id="total${p.id}">‚Çπ${calculateTotal(p.price, p.discount, p.qty)}</span></p>
                    <button class="btn btn-success mt-auto fw-bold shadow-sm" onclick="orderWhatsApp('${p.id}')">
                        Order on WhatsApp
                    </button>
                </div>
            </div>
        `;
        container.appendChild(col);
    });
}

function calculateTotal(price, discount = 0, qty) {
    let discountedPrice = price - (price * (discount / 100));
    return Math.round(discountedPrice * qty);
}

function changeQty(id, type) {
    let p = products.find(x => x.id == id);
    if (!p) return;
    if (type === "plus") p.qty++;
    if (type === "minus" && p.qty > 1) p.qty--;
    
    document.getElementById("qty" + id).innerText = p.qty;
    document.getElementById("total" + id).innerText = "‚Çπ" + calculateTotal(p.price, p.discount, p.qty);
}

function orderWhatsApp(id) {
    let p = products.find(x => x.id == id);
    if (!p) return;
    let finalPrice = calculateTotal(p.price, p.discount, p.qty);
    let msg = `*Order Inquiry - Customic Store*\n\n` +
              `*Product:* ${p.name}\n` +
              `*Quantity:* ${p.qty}\n` +
              `*Price per unit:* ‚Çπ${p.price}\n` +
              `*Discount:* ${p.discount}%\n` +
              `*Total Amount:* ‚Çπ${finalPrice}\n\n` +
              `Please confirm the order!`;
    window.open("https://wa.me/918799099135?text=" + encodeURIComponent(msg), "_blank");
}

/* ============ UTILS ============== */
function loadCommonFile(id, url) {
    fetch(url)
        .then(r => r.text())
        .then(d => { document.getElementById(id).innerHTML = d; })
        .catch(() => console.log(id + " not found"));
}

window.onload = () => {
    loadProducts();
    loadCommonFile("navbar", "/static/navbar.html");
    loadCommonFile("footer", "/static/footer.html");
    setInterval(loadProducts, 5000); // 5 seconds mein sync karega
};
</script>
</body>
</html>