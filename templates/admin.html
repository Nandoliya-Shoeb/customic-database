<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel | Add Products</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-img { height: 55px; width: 55px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        .sticky-form { position: sticky; top: 20px; z-index: 1000; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px 20px; border-bottom: 2px solid #eee; margin-bottom: 25px; border-radius: 12px; }
    </style>
    <script>
        // Security check
        if(localStorage.getItem("adminLoggedIn") !== "yes") {
            window.location.href = "/login";
        }
    </script>
</head>
<body class="bg-light">
<div class="container mt-3">
    <div class="admin-header shadow-sm">
        <h4 class="mb-0 fw-bold text-primary">üöÄ Customic Inventory</h4>
        <button class="btn btn-outline-danger btn-sm fw-bold" onclick="logoutAdmin()">Logout</button>
    </div>

    <div class="card shadow-sm p-4 mb-4 sticky-form border-0">
        <h5 id="formTitle" class="fw-bold mb-3">Add New Product</h5>
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label small fw-bold">Product Name</label>
                <input id="name" class="form-control" placeholder="Name">
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold">Price (‚Çπ)</label>
                <input id="price" type="number" class="form-control" placeholder="Price">
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold">Discount %</label>
                <input id="discount" type="number" class="form-control" placeholder="0">
            </div>
            <div class="col-md-4">
                <label class="form-label small fw-bold">Category</label>
                <select id="category" class="form-select">
                    <option value="keychains">Keychains</option>
                    <option value="lamp">Lamp</option>
                    <option value="pen">Pen</option>
                    <option value="penpot">Penpot</option>
                    <option value="tempset">Tempset</option>
                    <option value="wallets">Wallets</option>
                </select>
            </div>
            <div class="col-md-8">
                <label class="form-label small fw-bold">Product Image</label>
                <input id="image" type="file" class="form-control" accept="image/*">
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button id="saveBtn" class="btn btn-primary w-100 fw-bold" onclick="saveProduct()">Save Product</button>
            </div>
        </div>
        <button id="cancelBtn" class="btn btn-link text-danger d-none mt-2 fw-bold text-decoration-none" onclick="resetForm()">‚úï Cancel Edit</button>
    </div>

    <div class="card shadow-sm border-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr><th>Image</th><th>Details</th><th>Category</th><th>Actions</th></tr>
                </thead>
                <tbody id="productTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let editId = null;
let oldImageData = "";

async function loadProducts() {
    try {
        const res = await fetch('/api/products');
        const products = await res.json();
        const tbody = document.getElementById("productTable");
        tbody.innerHTML = "";
        products.forEach(p => {
            tbody.innerHTML += `<tr>
                <td><img src="${p.image}" class="product-img"></td>
                <td><b>${p.name}</b><br><small class="text-muted">‚Çπ${p.price} (${p.discount}% off)</small></td>
                <td><span class="badge bg-secondary">${p.category}</span></td>
                <td>
                    <button class="btn btn-sm btn-warning fw-bold" onclick="editProduct('${p.id}','${p.name}','${p.price}','${p.discount}','${p.category}','${p.image}')">Edit</button>
                    <button class="btn btn-sm btn-danger fw-bold" onclick="deleteProduct('${p.id}')">Delete</button>
                </td>
            </tr>`;
        });
    } catch (e) { console.error("Error loading products"); }
}

async function saveProduct() {
    const name = document.getElementById("name").value.trim();
    const price = document.getElementById("price").value;
    const file = document.getElementById("image").files[0];

    if(!name || !price) return alert("Please fill Name and Price!");

    const saveBtn = document.getElementById("saveBtn");
    saveBtn.disabled = true; saveBtn.innerText = "Saving...";

    let imageData = oldImageData;
    if(file) {
        imageData = await new Promise(r => {
            const rd = new FileReader(); rd.readAsDataURL(file);
            rd.onload = e => r(e.target.result);
        });
    }

    const data = { 
        id: editId || "P"+Date.now(), 
        name, 
        price: parseFloat(price), 
        discount: parseInt(document.getElementById("discount").value) || 0, 
        category: document.getElementById("category").value, 
        image: imageData 
    };
    
    try {
        const res = await fetch('/api/products', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify(data) 
        });
        if(res.ok) {
            alert("‚úÖ Product Saved!");
            resetForm();
            loadProducts();
        }
    } catch (err) { alert("Error saving product"); }
    finally { saveBtn.disabled = false; saveBtn.innerText = "Save Product"; }
}

async function deleteProduct(id) {
    if(confirm("Are you sure you want to delete this?")) { 
        await fetch('/api/products/'+id, {method:'DELETE'}); 
        loadProducts(); 
    }
}

function editProduct(id, name, price, discount, category, image) {
    editId = id; 
    oldImageData = image;
    document.getElementById("name").value = name;
    document.getElementById("price").value = price;
    document.getElementById("discount").value = discount;
    document.getElementById("category").value = category;
    document.getElementById("formTitle").innerText = "üìù Edit Product";
    document.getElementById("saveBtn").innerText = "Update Product";
    document.getElementById("cancelBtn").classList.remove("d-none");
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function resetForm() {
    editId = null; 
    oldImageData = "";
    document.getElementById("name").value = "";
    document.getElementById("price").value = "";
    document.getElementById("discount").value = "";
    document.getElementById("image").value = "";
    document.getElementById("formTitle").innerText = "Add New Product";
    document.getElementById("saveBtn").innerText = "Save Product";
    document.getElementById("cancelBtn").classList.add("d-none");
}

function logoutAdmin() {
    if(confirm("Do you want to logout?")) {
        localStorage.removeItem("adminLoggedIn");
        window.location.href = "/logout";
    }
}

window.onload = loadProducts;
</script>
</body>
</html>